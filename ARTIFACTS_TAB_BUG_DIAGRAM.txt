════════════════════════════════════════════════════════════════════════════════
                    ARTIFACTS TAB VISIBILITY BUG - VISUAL FLOW
════════════════════════════════════════════════════════════════════════════════

CURRENT (BROKEN) FLOW:
────────────────────────────────────────────────────────────────────────────────

                                Task Status Updates
                                        │
                                        ▼
                        ┌───────────────────────────┐
                        │   update_task(task)       │
                        │   (task_details.py:444)   │
                        └───────────────────────────┘
                                        │
                        ┌───────────────┴───────────────┐
                        │                               │
                        ▼                               ▼
            ┌──────────────────────┐      ┌──────────────────────┐
            │ _sync_desktop(task)  │      │ _sync_artifacts(???) │
            │    (line 449)        │      │   NOT CALLED! ✗      │
            └──────────────────────┘      └──────────────────────┘
                        │                               │
                        ▼                               ▼
            Desktop tab appears/hides         Artifacts tab NEVER updates
                  dynamically ✓                    stays hidden ✗


WHY ARTIFACTS ARE INVISIBLE:
────────────────────────────────────────────────────────────────────────────────

    Agent writes file          task.artifacts         _sync_artifacts()
    to staging                 field status           checks
    ─────────────────          ───────────────        ────────────────
    
    ┌─── Task Running ────────────────────────────────────────────────┐
    │                                                                  │
    │  Agent: Write file.txt     task.artifacts = []                  │
    │  → /tmp/agents-artifacts/  (empty list)                         │
    │     file.txt                                                     │
    │                                                                  │
    │  Host sees file at:        task.artifacts = []                  │
    │  ~/.midoriai/.../staging/  (still empty)                        │
    │     file.txt               ─────────────────                    │
    │                                                                  │
    │  Status update fires:      task.artifacts = []                  │
    │  update_task(task)         (still empty)                        │
    │    ✓ _sync_desktop(task)                                        │
    │    ✗ _sync_artifacts(???)  ← NOT CALLED!                        │
    │                                                                  │
    │  _sync_artifacts logic:    has_artifacts = bool(task.artifacts) │
    │  (only runs on show_task)  has_artifacts = bool([])             │
    │                            has_artifacts = False ✗               │
    │                            → Tab stays hidden                    │
    └──────────────────────────────────────────────────────────────────┘
    
    ┌─── Task Completes ──────────────────────────────────────────────┐
    │                                                                  │
    │  Artifacts finalized:      task.artifacts = ["uuid-123"]        │
    │  - Staging encrypted       (NOW populated)                      │
    │  - UUIDs stored            ─────────────────                    │
    │                                                                  │
    │  Status update fires:      task.artifacts = ["uuid-123"]        │
    │  update_task(task)                                              │
    │    ✓ _sync_desktop(task)                                        │
    │    ✗ _sync_artifacts(???)  ← STILL NOT CALLED!                  │
    │                                                                  │
    │  _sync_artifacts never     has_artifacts = bool(["uuid-123"])   │
    │  runs, so tab stays hidden has_artifacts = True                 │
    │                            But check never happens! ✗            │
    │                            → Tab STILL hidden                    │
    └──────────────────────────────────────────────────────────────────┘
    
    ┌─── User Navigates Away & Back ──────────────────────────────────┐
    │                                                                  │
    │  show_task(task) called:   task.artifacts = ["uuid-123"]        │
    │    ✓ _sync_desktop(task)                                        │
    │    ✓ _sync_artifacts(task) ← FINALLY CALLED!                    │
    │                            ─────────────────                    │
    │  _sync_artifacts logic:    has_artifacts = bool(["uuid-123"])   │
    │                            has_artifacts = True ✓                │
    │                            → _show_artifacts_tab()               │
    │                            → Tab appears! ✓                      │
    └──────────────────────────────────────────────────────────────────┘


CORRECT (FIXED) FLOW:
────────────────────────────────────────────────────────────────────────────────

                                Task Status Updates
                                        │
                                        ▼
                        ┌───────────────────────────┐
                        │   update_task(task)       │
                        │   (task_details.py:444)   │
                        └───────────────────────────┘
                                        │
                        ┌───────────────┴───────────────┐
                        │                               │
                        ▼                               ▼
            ┌──────────────────────┐      ┌──────────────────────┐
            │ _sync_desktop(task)  │      │ _sync_artifacts(task)│
            │    (line 449)        │      │    (line 455) ✓      │
            └──────────────────────┘      └──────────────────────┘
                        │                               │
                        ▼                               ▼
            Desktop tab appears/hides         Artifacts tab appears/hides
                  dynamically ✓                       dynamically ✓


ENHANCED _sync_artifacts() LOGIC:
────────────────────────────────────────────────────────────────────────────────

    def _sync_artifacts(self, task: Task) -> None:
        # OLD (broken):
        has_artifacts = bool(task.artifacts)  # Only checks encrypted
        
        # NEW (fixed):
        has_encrypted = bool(task.artifacts)  # Check encrypted
        
        has_staging = False
        if task.status in ["running", "queued", "created"]:
            staging_dir = get_staging_dir(task.task_id)
            has_staging = staging_dir.exists() and any(
                f.is_file() for f in staging_dir.iterdir()
            )  # ✓ Also check staging during execution
        
        has_artifacts = has_encrypted or has_staging  # ✓ Check BOTH
        
        if has_artifacts:
            self._show_artifacts_tab()
        else:
            self._hide_artifacts_tab()


DATA FLOW COMPARISON:
────────────────────────────────────────────────────────────────────────────────

Current (Desktop - WORKS):                Fixed (Artifacts):
─────────────────────────                 ──────────────────────

show_task(task)                          show_task(task)
  └─ _sync_desktop(task) ✓                 └─ _sync_artifacts(task) ✓

update_task(task)                        update_task(task)
  └─ _sync_desktop(task) ✓                 └─ _sync_artifacts(task) ✓
     └─ if headless_desktop_enabled:          └─ if task.artifacts OR
        show Desktop tab                           staging_has_files:
                                                  show Artifacts tab


TWO-PART FIX REQUIRED:
────────────────────────────────────────────────────────────────────────────────

╔═══════════════════════════════════════════════════════════════════════════╗
║  FIX 1: Call _sync_artifacts() in update_task()                          ║
║  ───────────────────────────────────────────                              ║
║  File: agents_runner/ui/pages/task_details.py                            ║
║  Line: 454 (after self._sync_review_menu(task))                          ║
║  Add:  self._sync_artifacts(task)                                        ║
║                                                                           ║
║  Impact: Tab visibility will now update on status changes                ║
╚═══════════════════════════════════════════════════════════════════════════╝

╔═══════════════════════════════════════════════════════════════════════════╗
║  FIX 2: Check staging directory in _sync_artifacts()                     ║
║  ────────────────────────────────────────────────                         ║
║  File: agents_runner/ui/pages/task_details.py                            ║
║  Line: 516-521 (entire _sync_artifacts function)                         ║
║  Change: Add staging directory check for running tasks                   ║
║                                                                           ║
║  Impact: Tab will appear when staging files exist (during execution)     ║
╚═══════════════════════════════════════════════════════════════════════════╝


BONUS FIX (Recommended):
────────────────────────────────────────────────────────────────────────────────

╔═══════════════════════════════════════════════════════════════════════════╗
║  FIX 3: Load artifacts when tab becomes visible                          ║
║  ───────────────────────────────────────────────                          ║
║  File: agents_runner/ui/pages/task_details.py                            ║
║  Line: 358-363 (_show_artifacts_tab method)                              ║
║  Add:  QTimer.singleShot(0, self._load_artifacts)                        ║
║                                                                           ║
║  Impact: Tab content will be initialized when it appears                 ║
╚═══════════════════════════════════════════════════════════════════════════╝


════════════════════════════════════════════════════════════════════════════════
                                  END DIAGRAM
════════════════════════════════════════════════════════════════════════════════
